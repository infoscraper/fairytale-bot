"""OpenAI service for story generation"""
import asyncio
import time
from typing import Optional, List, Dict
from openai import AsyncOpenAI

from ..core.config import settings
from ..models.child import Child


class OpenAIService:
    """Service for OpenAI API interactions"""
    
    def __init__(self):
        self.client = AsyncOpenAI(api_key=settings.OPENAI_API_KEY)
    
    async def generate_story(
        self,
        child: Child,
        theme: Optional[str] = None,
        custom_theme: Optional[str] = None
    ) -> Dict[str, str]:
        """Generate personalized story for child"""
        
        # Build context about the child
        context = self._build_child_context(child)
        
        # Determine the theme
        story_theme = custom_theme or theme or self._suggest_theme_from_interests(child.interests)
        
        # Build the prompt
        prompt = self._build_story_prompt(child, context, story_theme)
        
        try:
            # Start timing
            start_time = time.time()
            
            # Use Chat Completions API with proper parameters for GPT-5
            request_params = {
                "model": settings.OPENAI_MODEL,
                "messages": [
                    {"role": "system", "content": self._get_storyteller_system_prompt()},
                    {"role": "user", "content": prompt}
                ]
            }
            
            # Use correct parameters based on model
            if settings.OPENAI_MODEL.startswith('gpt-5'):
                request_params["max_completion_tokens"] = 800  # –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –¥–µ—Ç—Å–∫–∏—Ö —Å–∫–∞–∑–æ–∫
                # GPT-5 uses default temperature=1.0 only
            else:
                request_params["max_tokens"] = 800  # –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è 10-–º–∏–Ω—É—Ç–Ω—ã—Ö —Å–∫–∞–∑–æ–∫
                request_params["temperature"] = 0.8
            
            response = await self.client.chat.completions.create(**request_params)
            
            story_text = response.choices[0].message.content
            tokens_used = response.usage.total_tokens if response.usage else 0
            
            # Debug logging for GPT-5
            print(f"üîç DEBUG - Model: {settings.OPENAI_MODEL}")
            print(f"üîç DEBUG - Raw response content: {story_text[:200]}...")
            print(f"üîç DEBUG - Content length: {len(story_text) if story_text else 0}")
            print(f"üîç DEBUG - Tokens used: {tokens_used}")
            
            if not story_text or not story_text.strip():
                print("‚ùå WARNING: Empty story text received from GPT!")
                print(f"‚ùå Full response: {response}")
                raise Exception("GPT –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")
            
            # Calculate generation time
            generation_time = time.time() - start_time
            
            return {
                "story_text": story_text,
                "theme": story_theme,
                "characters": child.favorite_characters,
                "moral": self._extract_moral_from_story(story_text),
                "tokens_used": tokens_used,
                "generation_time": round(generation_time, 2)
            }
            
        except Exception as e:
            # More detailed error handling
            if "rate_limit" in str(e).lower():
                raise Exception("‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.")
            elif "invalid_api_key" in str(e).lower():
                raise Exception("üîë –ü—Ä–æ–±–ª–µ–º–∞ —Å API –∫–ª—é—á–æ–º. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
            elif "insufficient_quota" in str(e).lower():
                raise Exception("üí∞ –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            elif "timeout" in str(e).lower():
                raise Exception("‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")
            elif "connection" in str(e).lower():
                raise Exception("üåê –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ —Å–µ—Ä–≤–µ—Ä—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            else:
                raise Exception(f"üòî –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å–∫–∞–∑–∫—É: {str(e)[:100]}...")
    
    def _build_child_context(self, child: Child) -> str:
        """Build context about the child for personalization"""
        
        characters_text = ", ".join(child.favorite_characters) if child.favorite_characters else "–ª—é–±—ã–µ –¥–æ–±—Ä—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏"
        interests_text = ", ".join(child.interests) if child.interests else "–æ–±—â–∏–µ –¥–µ—Ç—Å–∫–∏–µ —Ç–µ–º—ã"
        
        context = f"""
        –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –†–ï–ë–ï–ù–ö–ï:
        –ò–º—è: {child.name}
        –í–æ–∑—Ä–∞—Å—Ç: {child.age} –ª–µ—Ç
        –õ—é–±–∏–º—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏: {characters_text}
        –ò–Ω—Ç–µ—Ä–µ—Å—ã: {interests_text}
        –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –¥–ª–∏–Ω–∞ —Å–∫–∞–∑–∫–∏: {child.preferred_story_length} –º–∏–Ω—É—Ç —á—Ç–µ–Ω–∏—è
        """
        
        return context.strip()
    
    def _build_story_prompt(self, child: Child, context: str, theme: str) -> str:
        """Build the story generation prompt"""
        
        age_guidance = self._get_age_appropriate_guidance(child.age)
        
        prompt = f"""
        {context}
        
        –ó–ê–î–ê–ß–ê: –°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å–∫–∞–∑–∫—É –¥–ª—è {child.name}
        
        –¢–ï–ú–ê –°–ö–ê–ó–ö–ò: {theme}
        
        –¢–†–ï–ë–û–í–ê–ù–ò–Ø:
        1. {child.name} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≥–ª–∞–≤–Ω—ã–º –≥–µ—Ä–æ–µ–º –∏ –∞–∫—Ç–∏–≤–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º —Å–æ–±—ã—Ç–∏–π
        2. –í–∫–ª—é—á–∏ –ª—é–±–∏–º—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π —Ä–µ–±–µ–Ω–∫–∞ –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –≤ —Å—é–∂–µ—Ç
        3. {age_guidance}
        4. –ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–æ–±—Ä–∞—è, –ø–æ—É—á–∏—Ç–µ–ª—å–Ω–∞—è –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞—è. –ó–∞ –æ—Å–Ω–æ–≤—É –º–æ–∂–Ω–æ –≤–∑—è—Ç—å –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å–∫–∞–∑–∫–∏, –º—É–ª—å—Ç—Ñ–∏–ª—å–º—ã –∏ –∏—Å—Ç–æ—Ä–∏–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–≤ –∏—Ö –ø–æ–¥ –≤–æ–∑—Ä–∞—Å—Ç —Ä–µ–±–µ–Ω–∫–∞.
        5. –î–ª–∏–Ω–∞: –ø—Ä–∏–º–µ—Ä–Ω–æ {child.preferred_story_length} –º–∏–Ω—É—Ç —á—Ç–µ–Ω–∏—è
        6. –ò—Å–ø–æ–ª—å–∑—É–π —è—Ä–∫–∏–µ, –æ–±—Ä–∞–∑–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è
        7. –î–æ–±–∞–≤—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –≥–¥–µ —Ä–µ–±–µ–Ω–æ–∫ –º–æ–∂–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å–µ–±—è
        
        –°–¢–†–£–ö–¢–£–†–ê:
        - –£–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª–æ
        - –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞
        - –ê–∫—Ç–∏–≤–Ω–æ–µ —É—á–∞—Å—Ç–∏–µ {child.name} –≤ —Ä–µ—à–µ–Ω–∏–∏
        - –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Ñ–∏–Ω–∞–ª —Å –º–æ—Ä–∞–ª—å—é
        
        –°–æ–∑–¥–∞–π –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â—É—é –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ:
        """
        
        return prompt.strip()
    
    def _get_storyteller_system_prompt(self) -> str:
        """System prompt for the storyteller"""
        return """
        –¢—ã - –≤–æ–ª—à–µ–±–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑—á–∏–∫ —Å–∫–∞–∑–æ–∫ –¥–ª—è –¥–µ—Ç–µ–π. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–≤–∞—Ç—å:
        
        ‚ú® –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –≥–¥–µ —Ä–µ–±–µ–Ω–æ–∫ - –≥–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π
        ‚ú® –î–æ–±—Ä—ã–µ —Å–∫–∞–∑–∫–∏ —Å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞–º–∏
        ‚ú® –í–æ–∑—Ä–∞—Å—Ç–Ω–æ-–ø–æ–¥—Ö–æ–¥—è—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç –±–µ–∑ —Å—Ç—Ä–∞—à–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        ‚ú® –ò—Å—Ç–æ—Ä–∏–∏ —Å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–π –º–æ—Ä–∞–ª—å—é –∏ –≤–∞–∂–Ω—ã–º–∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º–∏ —É—Ä–æ–∫–∞–º–∏
        ‚ú® –Ø—Ä–∫–∏–µ, –æ–±—Ä–∞–∑–Ω—ã–µ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è
        
        –°–¢–†–û–ì–ò–ï –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:
        üö´ –ó–ê–ü–†–ï–©–ï–ù–û –í–ö–õ–Æ–ß–ê–¢–¨:
        - –õ—é–±—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞—Å–∏–ª–∏—è, –∂–µ—Å—Ç–æ–∫–æ—Å—Ç–∏, —Å–º–µ—Ä—Ç–∏, –∫—Ä–æ–≤–∏
        - –°–µ–∫—Å—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏–ª–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
        - –ù–∞—Ä–∫–æ—Ç–∏–∫–∏, –∞–ª–∫–æ–≥–æ–ª—å, –∫—É—Ä–µ–Ω–∏–µ
        - –ù–µ—Ü–µ–Ω–∑—É—Ä–Ω—É—é –ª–µ–∫—Å–∏–∫—É –∏–ª–∏ –≥—Ä—É–±–æ—Å—Ç—å
        - –°—Ç—Ä–∞—à–Ω—ã—Ö –º–æ–Ω—Å—Ç—Ä–æ–≤, —É–∂–∞—Å—ã, –∫–æ—à–º–∞—Ä—ã
        - –û—Ä—É–∂–∏–µ, –¥—Ä–∞–∫–∏, –≤–æ–π–Ω—ã, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
        - –ü–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ —Ä–µ–ª–∏–≥–∏–æ–∑–Ω—ã–µ —Å–ø–æ—Ä—ã
        - –û–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è (–ø—Ä—ã–∂–∫–∏ —Å –≤—ã—Å–æ—Ç—ã, –æ—Ç—Ä–∞–≤–ª–µ–Ω–∏—è –∏ —Ç.–¥.)
        - –û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ, –¥–µ–ø—Ä–µ—Å—Å–∏—é, –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ —ç–º–æ—Ü–∏–∏
        - –û–±–º–∞–Ω, –ª–æ–∂—å, –Ω–µ—á–µ—Å—Ç–Ω–æ—Å—Ç—å (–∫—Ä–æ–º–µ –ø–æ—É—á–∏—Ç–µ–ª—å–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤)
        
        ‚úÖ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–ö–õ–Æ–ß–ê–¢–¨:
        - –¢–æ–ª—å–∫–æ –¥–æ–±—Ä—ã—Ö, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        - –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å—é–∂–µ—Ç—ã —Å —Ä–µ—à–µ–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º
        - –°—á–∞—Å—Ç–ª–∏–≤—ã–µ –∫–æ–Ω—Ü–æ–≤–∫–∏
        - –ü–æ—É—á–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ—Ä–∞–ª–∏ –æ –¥—Ä—É–∂–±–µ, –¥–æ–±—Ä–æ—Ç–µ, —á–µ—Å—Ç–Ω–æ—Å—Ç–∏
        - –í–∑–∞–∏–º–æ–ø–æ–º–æ—â—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É
        - –í–æ–ª—à–µ–±—Å—Ç–≤–æ –∏ —á—É–¥–µ—Å–∞ –¥–æ–±—Ä–∞
        - –ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –±–µ–∑ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏
        
        –í–ê–ñ–ù–û: –†–µ–±–µ–Ω–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–º, –∞ –Ω–µ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–º!
        –ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Å—å –∏ —Å–æ–∑–¥–∞–π –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É.
        –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.
        """
    
    def _get_age_appropriate_guidance(self, age: int) -> str:
        """Get age-appropriate story guidance with length adaptation"""
        age_adaptations = self._get_age_adaptations(age)
        
        base_guidance = ""
        if age <= 3:
            base_guidance = "–ü—Ä–æ—Å—Ç–æ–π —Å—é–∂–µ—Ç, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ —Ñ–æ—Ä–º—ã, –∑–Ω–∞–∫–æ–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã"
        elif age <= 5:
            base_guidance = "–ü—Ä–æ—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ø–æ–Ω—è—Ç–Ω—ã–µ —ç–º–æ—Ü–∏–∏, –¥—Ä—É–∂–±–∞ –∏ —Å–µ–º—å—è, –º–∞–≥–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã"
        elif age <= 7:
            base_guidance = "–ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–π —Å—é–∂–µ—Ç, –ø—Ä–æ–±–ª–µ–º—ã –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—è, —Ö—Ä–∞–±—Ä–æ—Å—Ç—å –∏ –¥–æ–±—Ä–æ—Ç–∞"
        else:  # 8 –ª–µ—Ç
            base_guidance = "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è, –º–æ—Ä–∞–ª—å–Ω—ã–µ –≤—ã–±–æ—Ä—ã, –¥—Ä—É–∂–±–∞ –∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å"
        
        return f"{base_guidance}. –î–õ–ò–ù–ê: {age_adaptations['word_count']} —Å–ª–æ–≤. –Ø–ó–´–ö: {age_adaptations['complexity']}"
    
    def _get_age_adaptations(self, age: int) -> Dict[str, str]:
        """Get age-appropriate adaptations for story length and complexity"""
        if age <= 3:
            return {
                'word_count': '150-200',
                'complexity': '–ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞, –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
                'structure': '–ø—Ä–æ—Å—Ç–∞—è –ª–∏–Ω–µ–π–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏',
                'moral_style': '–æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–∞—è –∏ –ø—Ä—è–º–∞—è –º–æ—Ä–∞–ª—å'
            }
        elif age <= 5:
            return {
                'word_count': '250-350',
                'complexity': '–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–æ–≤–∞, —Å—Ä–µ–¥–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
                'structure': '—è—Å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∑–∞–≤—è–∑–∫–æ–π, —Ä–∞–∑–≤–∏—Ç–∏–µ–º –∏ –∫–æ–Ω—Ü–æ–≤–∫–æ–π',
                'moral_style': '–ø–æ–Ω—è—Ç–Ω–∞—è –º–æ—Ä–∞–ª—å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏'
            }
        elif age <= 7:
            return {
                'word_count': '400-550',
                'complexity': '—Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞, —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
                'structure': '–ø–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏',
                'moral_style': '–≥–ª—É–±–æ–∫–∞—è –º–æ—Ä–∞–ª—å —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º'
            }
        else:  # 8 –ª–µ—Ç
            return {
                'word_count': '600-800',
                'complexity': '–±–æ–≥–∞—Ç–∞—è –ª–µ–∫—Å–∏–∫–∞, —Å–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
                'structure': '—Ä–∞–∑–≤–∏—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –ø–æ–¥—Å—é–∂–µ—Ç–∞–º–∏',
                'moral_style': '–º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –º–æ—Ä–∞–ª—å –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è'
            }
    
    def _suggest_theme_from_interests(self, interests: List[str]) -> str:
        """Suggest theme based on child's interests"""
        if not interests:
            return "–≤–æ–ª—à–µ–±–Ω–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ"
        
        # Pick random interest as theme
        import random
        return random.choice(interests)
    
    def _extract_moral_from_story(self, story_text: str) -> str:
        """Extract moral from the story (enhanced with 40 diverse morals)"""
        import random
        
        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –º–æ—Ä–∞–ª–µ–π –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ
        morals = {
            "–¥—Ä—É–∂–±–∞": "–î—Ä—É–∂–±–∞ ‚Äî —ç—Ç–æ –æ–¥–Ω–æ –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Å–æ–∫—Ä–æ–≤–∏—â –≤ –∂–∏–∑–Ω–∏",
            "–¥—Ä—É–≥": "–ù–∞—Å—Ç–æ—è—â–∏–π –¥—Ä—É–≥ –≤—Å–µ–≥–¥–∞ —Ä—è–¥–æ–º, –∫–æ–≥–¥–∞ —Ç—Ä—É–¥–Ω–æ",
            "–≤–º–µ—Å—Ç–µ": "–õ—É—á—à–µ –≤–º–µ—Å—Ç–µ, —á–µ–º –ø–æ–æ–¥–∏–Ω–æ—á–∫–µ",
            
            "–¥–æ–±—Ä–æ—Ç–∞": "–î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ—Å—Ç—É–ø–∫–∏ –¥–æ–±—Ä–æ—Ç—ã –¥–µ–ª–∞—é—Ç –º–∏—Ä –ª—É—á—à–µ",
            "–¥–æ–±—Ä—ã–π": "–î–æ–±—Ä–æ –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è",
            "–¥–æ–±—Ä–æ": "–°–∞–º–æ–µ —Ü–µ–Ω–Ω–æ–µ –±–æ–≥–∞—Ç—Å—Ç–≤–æ ‚Äî —ç—Ç–æ –¥–æ–±—Ä—ã–µ –¥–µ–ª–∞",
            "–ø–æ–º–æ—â—å": "–¢–æ—Ç, –∫—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –¥—Ä—É–≥–∏–º, –ø–æ–º–æ–≥–∞–µ—Ç –∏ —Å–µ–±–µ",
            "–ø–æ–º–æ–≥–∞—Ç—å": "–ö—Ç–æ –∑–∞–±–æ—Ç–∏—Ç—Å—è –æ –¥—Ä—É–≥–∏—Ö, —Ç–æ—Ç –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –æ–¥–∏–Ω",
            
            "—Ö—Ä–∞–±—Ä–æ—Å—Ç—å": "–ù–∞—Å—Ç–æ—è—â–∞—è —Å–º–µ–ª–æ—Å—Ç—å ‚Äî –Ω–µ –≤ —Å–∏–ª–µ, –∞ –≤ —Å–µ—Ä–¥—Ü–µ",
            "—Å–º–µ–ª–æ—Å—Ç—å": "–°–º–µ–ª–æ—Å—Ç—å ‚Äî —ç—Ç–æ –Ω–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä–∞—Ö–∞, –∞ —É–º–µ–Ω–∏–µ –µ–≥–æ –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å",
            "—Å–º–µ–ª—ã–π": "–ú–∞–ª–µ–Ω—å–∫–∏–µ –≥–µ—Ä–æ–∏ —Ç–æ–∂–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç –±–æ–ª—å—à–∏–µ –¥–µ–ª–∞",
            "—Å—Ç—Ä–∞—Ö": "–ù–µ —Å—Ç–æ–∏—Ç –±–æ—è—Ç—å—Å—è –ø—Ä–æ—Å–∏—Ç—å –ø–æ–º–æ—â–∏",
            
            "—á–µ—Å—Ç–Ω–æ—Å—Ç—å": "–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ –≤–∞–∂–Ω–µ–µ –æ–±–º–∞–Ω–∞",
            "–ø—Ä–∞–≤–¥–∞": "–î–æ–≤–µ—Ä–∏–µ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ—Å—Ç—É–ø–∫–∞–º–∏",
            "–æ–±–º–∞–Ω": "–ß–µ—Å—Ç–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ –≤–∞–∂–Ω–µ–µ –æ–±–º–∞–Ω–∞",
            
            "—Ç—Ä—É–¥": "–¢—Ä—É–¥ –∏ —Ç–µ—Ä–ø–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞—é—Ç –¥–æ—Å—Ç–∏—á—å –º–µ—á—Ç—ã",
            "—Ä–∞–±–æ—Ç–∞": "–ú–µ—á—Ç—ã —Å–±—ã–≤–∞—é—Ç—Å—è, –µ—Å–ª–∏ –≤–µ—Ä–∏—Ç—å –∏ —Å—Ç–∞—Ä–∞—Ç—å—Å—è",
            "–ª–µ–Ω—å": "–õ–µ–Ω—å –Ω–µ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —É—Å–ø–µ—Ö—É",
            "—Ç–µ—Ä–ø–µ–Ω–∏–µ": "–¢–µ—Ä–ø–µ–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏",
            
            "–¥–µ–ª–∏": "–î–µ–ª–∏—Å—å —Å –¥—Ä—É–≥–∏–º–∏, –∏ —Å—á–∞—Å—Ç—å—è —Å—Ç–∞–Ω–µ—Ç –±–æ–ª—å—à–µ",
            "—â–µ–¥—Ä–æ—Å—Ç—å": "–©–µ–¥—Ä–æ—Å—Ç—å –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å—á–∞—Å—Ç–ª–∏–≤—ã–º",
            "–∂–∞–¥–Ω–æ—Å—Ç—å": "–°–µ–∫—Ä–µ—Ç —Å—á–∞—Å—Ç—å—è ‚Äî –≤ —É–º–µ–Ω–∏–∏ –¥–µ–ª–∏—Ç—å—Å—è",
            
            "–ø—Ä–∏—Ä–æ–¥–∞": "–£–≤–∞–∂–∞–π –ø—Ä–∏—Ä–æ–¥—É –∏ –∑–∞–±–æ—Ç—å—Å—è –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö",
            "–∂–∏–≤–æ—Ç–Ω—ã–µ": "–£–≤–∞–∂–∞–π –ø—Ä–∏—Ä–æ–¥—É –∏ –∑–∞–±–æ—Ç—å—Å—è –æ –∂–∏–≤–æ—Ç–Ω—ã—Ö",
            
            "–æ—Å–æ–±–µ–Ω–Ω—ã–π": "–ö–∞–∂–¥—ã–π –æ—Å–æ–±–µ–Ω–Ω—ã–π –ø–æ-—Å–≤–æ–µ–º—É, –∏ —ç—Ç–æ —Ü–µ–Ω–Ω–æ",
            "–∫—Ä–∞—Å–æ—Ç–∞": "–ù–∞—Å—Ç–æ—è—â–∞—è –∫—Ä–∞—Å–æ—Ç–∞ ‚Äî –≤–Ω—É—Ç—Ä–∏ —á–µ–ª–æ–≤–µ–∫–∞",
            "–≤–Ω–µ—à–Ω–æ—Å—Ç—å": "–ù–µ —Å—É–¥–∏ –¥—Ä—É–≥–∏—Ö –ø–æ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏",
            
            "–∑–∞–≤–∏—Å—Ç—å": "–ó–∞–≤–∏—Å—Ç—å —Ä–∞–∑—Ä—É—à–∞–µ—Ç –¥—Ä—É–∂–±—É",
            "–∑–ª–æ—Å—Ç—å": "–ù–µ–ª—å–∑—è –±—ã—Ç—å —Å—á–∞—Å—Ç–ª–∏–≤—ã–º, –æ–±–∏–∂–∞—è –¥—Ä—É–≥–∏—Ö",
            
            "—É–ª—ã–±–∫–∞": "–£–ª—ã–±–∫–∞ –∏ –¥–æ–±—Ä–æ–µ —Å–ª–æ–≤–æ –º–æ–≥—É—Ç –∏–∑–º–µ–Ω–∏—Ç—å –¥–µ–Ω—å",
            "—Å–º–µ—Ö": "–°–º–µ—Ö –∏ —Ä–∞–¥–æ—Å—Ç—å –¥–µ–ª–∞—é—Ç –∂–∏–∑–Ω—å —è—Ä—á–µ",
            "—Ä–∞–¥–æ—Å—Ç—å": "–°–º–µ—Ö –∏ —Ä–∞–¥–æ—Å—Ç—å –¥–µ–ª–∞—é—Ç –∂–∏–∑–Ω—å —è—Ä—á–µ",
            
            "—É—á–µ–Ω–∏–µ": "–£—á–∏—Ç—å—Å—è –Ω–æ–≤–æ–º—É ‚Äî —ç—Ç–æ –≤—Å–µ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ",
            "–æ—à–∏–±–∫–∞": "–û—à–∏–±–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è —É–º–Ω–µ–µ",
            "—É–º–Ω—ã–π": "–£–º –≤–∞–∂–Ω–µ–µ —Å–∏–ª—ã",
            
            "—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å": "–°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –≤—ã–≥–æ–¥—ã",
            "–≤–µ–∂–ª–∏–≤–æ—Å—Ç—å": "–í–µ–∂–ª–∏–≤–æ—Å—Ç—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Ä–¥—Ü–∞ –ª—é–¥–µ–π",
            "—É—Å—Ç—É–ø–∞—Ç—å": "–ò–Ω–æ–≥–¥–∞ –Ω—É–∂–Ω–æ —É–º–µ—Ç—å —É—Å—Ç—É–ø–∏—Ç—å",
            
            "—Å–µ–º—å—è": "–õ—é–±–æ–≤—å –∏ –∑–∞–±–æ—Ç–∞ –¥–µ–ª–∞—é—Ç —Å–µ–º—å—é –∫—Ä–µ–ø–∫–æ–π",
            "–º—É–¥—Ä–æ—Å—Ç—å": "–í–∞–∂–Ω–æ —Å–ª—É—à–∞—Ç—å —Å—Ç–∞—Ä—à–∏—Ö –∏ –º—É–¥—Ä—ã—Ö",
            "–±–µ—Ä–µ—á—å": "–ù—É–∂–Ω–æ –±–µ—Ä–µ—á—å —Ç–æ, —á—Ç–æ –∏–º–µ–µ—à—å"
        }
        
        story_lower = story_text.lower()
        
        # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
        found_morals = []
        for keyword, moral in morals.items():
            if keyword in story_lower:
                found_morals.append(moral)
        
        if found_morals:
            return random.choice(found_morals)
        
        # Fallback - —Å–ª—É—á–∞–π–Ω–∞—è –º–æ—Ä–∞–ª—å –∏–∑ –±–∞–∑–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞
        default_morals = [
            "–í–∞–∂–Ω–æ –±—ã—Ç—å –¥–æ–±—Ä—ã–º, —Å–º–µ–ª—ã–º –∏ –ø–æ–º–æ–≥–∞—Ç—å –¥—Ä—É–≥–∏–º",
            "–î—Ä—É–∂–±–∞ ‚Äî —ç—Ç–æ –æ–¥–Ω–æ –∏–∑ —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö —Å–æ–∫—Ä–æ–≤–∏—â –≤ –∂–∏–∑–Ω–∏", 
            "–î–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ—Å—Ç—É–ø–∫–∏ –¥–æ–±—Ä–æ—Ç—ã –¥–µ–ª–∞—é—Ç –º–∏—Ä –ª—É—á—à–µ",
            "–ù–∞—Å—Ç–æ—è—â–∞—è —Å–º–µ–ª–æ—Å—Ç—å ‚Äî –Ω–µ –≤ —Å–∏–ª–µ, –∞ –≤ —Å–µ—Ä–¥—Ü–µ",
            "–î–µ–ª–∏—Å—å —Å –¥—Ä—É–≥–∏–º–∏, –∏ —Å—á–∞—Å—Ç—å—è —Å—Ç–∞–Ω–µ—Ç –±–æ–ª—å—à–µ"
        ]
        
        return random.choice(default_morals)
    
    async def close(self):
        """Close the OpenAI client"""
        if self.client:
            await self.client.close()
